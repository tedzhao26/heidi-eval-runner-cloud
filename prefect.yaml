# Prefect project metadata
name: flows
prefect-version: 3.0.0

# ------------------------------
# Build only when requirements.txt changes
# ------------------------------
build:
  # Compute hash of requirements.txt to use as a tag
  - prefect.deployments.steps.run_shell_script:
      id: reqs-hash
      script: shasum requirements.txt | awk '{print $1}'
      stream_output: false

  # Build image tagged with that hash; skip if it already exists
  - prefect_docker.deployments.steps.build_docker_image:
      id: build-image
      requires: prefect-docker>=0.4.0
      image_name: "{{ $PREFECT_IMAGE_NAME }}"
      tag: "reqs-{{ reqs-hash.stdout }}"
      dockerfile: auto
      platform: "linux/amd64"
      skip_if_exists: true

# ------------------------------
# Push flow code to S3 (not Docker)
# ------------------------------
push:
  - prefect_aws.deployments.steps.push_to_s3:
      requires: prefect-aws>=0.3.0
      bucket: devai-demo-prefect-flows-bucket
      folder: eval-runner

# ------------------------------
# Pull latest code from S3 before each run
# ------------------------------
pull:
  - prefect_aws.deployments.steps.pull_from_s3:
      requires: prefect-aws>=0.3.0
      bucket: devai-demo-prefect-flows-bucket
      key: eval-runner
      local_path: /opt/prefect/flows

# ------------------------------
# Shared definitions for deployments
# ------------------------------
definitions:
  tags: &common_tags
    - "eks"
    - "reqs-{{ reqs-hash.stdout }}"
  work_pool: &common_work_pool
    name: "devai-k8s-worker"
    job_variables:
      image: "{{ build-image.image }}"  # Use the built image

# ------------------------------
# Deployments
# ------------------------------
deployments:
  - name: "eval-runner-deployment"
    tags: *common_tags
    schedule: null
    entrypoint: "flows/hello.py:hello"
    work_pool: *common_work_pool
