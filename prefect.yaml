# Prefect project metadata
name: flows
prefect-version: 3.0.0

# ------------------------------
# Build image with commit hash
# ------------------------------
build:
- prefect.deployments.steps.run_shell_script:
    id: get-commit-hash
    script: git rev-parse --short HEAD
    stream_output: false
- prefect_docker.deployments.steps.build_docker_image:
    requires: prefect-docker >= 0.4.0
    image_name: "{{ $PREFECT_IMAGE_NAME }}"
    image_tag: "{{ get-commit-hash.stdout }}"
    dockerfile: auto

# ------------------------------
# Push flow code to S3 (not Docker)
# ------------------------------

# push:
#   - prefect_aws.deployments.steps.push_to_s3:
#       id: push-code
#       requires: prefect-aws>=0.3.0
#       bucket: devai-demo-prefect-flows-bucket
#       folder: eval-runner

# ------------------------------
# Pull latest code from S3 before each run
# ------------------------------

# pull:
#   - prefect_aws.deployments.steps.pull_from_s3:
#       id: pull-code
#       requires: prefect-aws>=0.3.0
#       bucket: devai-demo-prefect-flows-bucket
#       folder: "{{ push-code.folder }}"
#       local_path: /opt/prefect/flows

# ------------------------------
# Shared definitions for deployments
# ------------------------------
definitions:
  tags: &common_tags
    - "eks"
    - "reqs-{{ reqs-hash.stdout }}"
  work_pool: &common_work_pool
    name: "devai-k8s-worker"
    job_variables:
      image: "{{ build-image.image }}"  # Use the built image

# ------------------------------
# Deployments
# ------------------------------
deployments:
  - name: "eval-runner-deployment"
    tags: *common_tags
    schedule: null
    entrypoint: "flows/hello.py:hello"
    work_pool: *common_work_pool
