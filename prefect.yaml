# Prefect project metadata
name: flows
prefect-version: 3.0.0


# ------------------------------
# Push flow code to S3 (not Docker)
# ------------------------------

push:
  - prefect_aws.deployments.steps.push_to_s3:
      id: push-code
      requires: prefect-aws>=0.3.0
      bucket: devai-demo-prefect-flows-bucket
      folder: eval-runner
      ignore_file: .prefectignore
      credentials: "{{ prefect.blocks.aws-credentials.credentials }}"



# ------------------------------
# Pull latest code from S3 before each run
# ------------------------------

pull:
  - prefect_aws.deployments.steps.pull_from_s3:
      id: pull-code
      requires: prefect-aws>=0.3.0
      bucket: devai-demo-prefect-flows-bucket
      folder: "{{ push-code.folder }}"
      credentials: "{{ prefect.blocks.aws-credentials.credentials }}"
  - prefect.deployments.steps.pip_install_requirements:
      directory: "{{ set-working-directory.directory }}"
      requirements_file: requirements.txt

# ------------------------------
# Shared definitions for deployments
# ------------------------------
definitions:
  tags: &common_tags
    - "eks"
    - "{{ set-working-directory.directory }}"
  work_pool: &common_work_pool
    name: "devai-k8s-worker"
    job_variables:
      image: "{{ $PREFECT_IMAGE_NAME }}"

# ------------------------------
# Deployments
# ------------------------------
deployments:
  - name: "eval-runner-deployment"
    tags: *common_tags
    schedule: null
    entrypoint: "flows/hello.py:hello"
    work_pool: *common_work_pool